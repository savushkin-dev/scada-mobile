<?xml version="1.0" encoding="UTF-8"?>
<!--
    logback-spring.xml — Конфигурация логирования для SCADA Mobile Backend
    =========================================================================
    Использует <springProfile> для разных поведений в dev и prod.

    Dev:  консоль (цвета) + plain text файл (.log), уровень DEBUG
    Prod: JSON файл (.json) с ротацией + AsyncAppender, уровень INFO

    Документация: LOGGING.md
-->
<configuration>

    <!-- =========================================================
         СВОЙСТВА: пути и имена файлов
         Переопределяются через переменную окружения LOG_PATH
         ========================================================= -->
    <springProperty name="APP_NAME" source="spring.application.name" defaultValue="scada-backend"/>
    <property name="LOG_PATH" value="${LOG_PATH:-./logs}"/>
    <property name="LOG_ARCHIVE" value="${LOG_PATH}/archived"/>

    <!-- =========================================================
         APPENDER 1: CONSOLE (только для dev профиля)
         Цветной вывод — не используем в prod (лишняя нагрузка
         при перенаправлении systemd/docker + нет пользы от цветов)
         ========================================================= -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <!--
                %X{requestId:-      } — MDC requestId (8 символов), если нет — пробелы (выравнивание)
                %X{method:-    }     — HTTP-метод запроса
                %X{uri}              — URI запроса (пусто для scan cycle / не-HTTP потоков)
            -->
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %highlight(%-5level) [%15.15thread] [%8.8X{requestId:- }]
                %cyan(%-40logger{40}) : %msg%n
            </pattern>
            <charset>UTF-8</charset>
        </encoder>
    </appender>

    <!-- =========================================================
         APPENDER 2: FILE_PLAIN (plain text файл, для dev)
         Файл: backend.log
         Ротация: ежедневно + при превышении 50MB
         Хранение: 30 дней, не более 500MB суммарно
         ========================================================= -->
    <appender name="FILE_PLAIN" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/${APP_NAME}.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_ARCHIVE}/${APP_NAME}.%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
            <maxFileSize>50MB</maxFileSize>
            <maxHistory>30</maxHistory>
            <totalSizeCap>500MB</totalSizeCap>
            <cleanHistoryOnStart>true</cleanHistoryOnStart>
        </rollingPolicy>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level [%15.15thread] [%8.8X{requestId:- }] %-40logger{40} : %msg%n
            </pattern>
            <charset>UTF-8</charset>
        </encoder>
    </appender>

    <!-- =========================================================
         APPENDER 3: FILE_JSON (JSON файл для prod — машиночитаемый)
         Файл: backend.json  (отдельное расширение, нет конфликта с FILE_PLAIN)
         Каждая строка — один JSON-объект.
         Удобно для grep + jq и для централизованного сбора логов.
         ========================================================= -->
    <appender name="FILE_JSON" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/${APP_NAME}.json</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_ARCHIVE}/${APP_NAME}.%d{yyyy-MM-dd}.%i.json.gz</fileNamePattern>
            <maxFileSize>50MB</maxFileSize>
            <maxHistory>30</maxHistory>
            <totalSizeCap>500MB</totalSizeCap>
            <cleanHistoryOnStart>true</cleanHistoryOnStart>
        </rollingPolicy>
        <encoder class="ch.qos.logback.classic.encoder.JsonEncoder">
            <!-- JsonEncoder встроен в Logback 1.4.x (Spring Boot 3.x+) -->
        </encoder>
    </appender>

    <!-- =========================================================
         APPENDER 4: ASYNC_FILE (обёртка над FILE_JSON для prod)
         Запись в отдельном потоке — не блокирует scan cycle и REST-потоки.

         Параметры:
           queueSize=512      — размер очереди (строки в буфере)
           discardingThreshold=0 — не выбрасывать DEBUG/INFO при заполнении (0 = не выбрасывать ничего)
           includeCallerData=false — не собирать stack frame (дорого, нужно только при WARN+)
         ========================================================= -->
    <appender name="ASYNC_FILE" class="ch.qos.logback.classic.AsyncAppender">
        <queueSize>512</queueSize>
        <discardingThreshold>0</discardingThreshold>
        <includeCallerData>false</includeCallerData>
        <neverBlock>false</neverBlock>
        <appender-ref ref="FILE_JSON"/>
    </appender>

    <!-- =========================================================
         ПРАВИЛА ДЛЯ DEV ПРОФИЛЯ
         - Консоль с цветами
         - Plain text файл
         - Подробные уровни для кода проекта
         ========================================================= -->
    <springProfile name="dev">
        <!-- Шумные сторонние библиотеки — не интересны при разработке -->
        <logger name="org.springframework" level="WARN"/>
        <logger name="org.apache" level="WARN"/>
        <logger name="com.fasterxml" level="WARN"/>
        <logger name="io.swagger" level="WARN"/>

        <!-- Код проекта — подробно -->
        <logger name="dev.savushkin.scada.mobile.backend" level="DEBUG"/>

        <!-- Инфраструктура polling (сокет, retry) — максимальные детали -->
        <logger name="dev.savushkin.scada.mobile.backend.infrastructure.polling" level="TRACE"/>
        <logger name="dev.savushkin.scada.mobile.backend.infrastructure.integration" level="TRACE"/>

        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="FILE_PLAIN"/>
        </root>
    </springProfile>

    <!-- =========================================================
         ПРАВИЛА ДЛЯ PROD ПРОФИЛЯ
         - Нет консоли
         - JSON файл через AsyncAppender
         - Минимальный шум: root=WARN, backend=INFO
         ========================================================= -->
    <springProfile name="prod">
        <!-- Сторонние библиотеки — только ошибки -->
        <logger name="org.springframework" level="WARN"/>
        <logger name="org.apache" level="WARN"/>
        <logger name="com.fasterxml" level="WARN"/>
        <logger name="io.swagger" level="OFF"/>

        <!-- Код проекта — INFO достаточно для штатной работы -->
        <logger name="dev.savushkin.scada.mobile.backend" level="INFO"/>

        <!-- Уровни переопределяются при инциденте через Actuator без перезапуска:
             POST /actuator/loggers/dev.savushkin.scada.mobile.backend
             {"configuredLevel": "DEBUG"}
        -->

        <root level="WARN">
            <appender-ref ref="ASYNC_FILE"/>
        </root>
    </springProfile>

    <!-- =========================================================
         FALLBACK: если профиль не задан (тесты, bare запуск)
         Только консоль — никаких файлов, чтобы не было конфликтов
         ========================================================= -->
    <springProfile name="!dev &amp; !prod">
        <logger name="dev.savushkin.scada.mobile.backend" level="DEBUG"/>
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>

</configuration>

