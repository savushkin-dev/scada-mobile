# ๐ Retry-ะผะตัะฐะฝะธะทะผ ะดะปั PrintSrv - ะะพะปะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั

## ๐ ะะฟะธัะฐะฝะธะต

ะััะธัะตะบัััะฝะพ ะณัะฐะผะพัะฝัะน retry-ะผะตัะฐะฝะธะทะผ ะดะปั ะฐะฒัะพะผะฐัะธัะตัะบะพะณะพ ะพะฟัะพัะฐ PrintSrv ัะตัะตะท Scheduler ั **ััะตัััะพะฒะฝะตะฒะพะน ัััะฐัะตะณะธะตะน**
ะพะฑัะฐะฑะพัะบะธ ะพัะธะฑะพะบ, ะพะฑะตัะฟะตัะธะฒะฐััะธะน ะฒััะพะบัั ัััะพะนัะธะฒะพััั ะบ ัะฑะพัะผ ะฟัะธ ะฟะพะปะฝะพะน ะฟัะพะทัะฐัะฝะพััะธ ะดะปั ะบะปะธะตะฝัะพะฒ REST API.

---

## ๐ฏ ะะปััะตะฒัะต ะฒะพะทะผะพะถะฝะพััะธ

- โ **Graceful Degradation** - ะบะปะธะตะฝัั ะฟะพะปััะฐัั ะฟะพัะปะตะดะฝะธะน ะฒะฐะปะธะดะฝัะน snapshot ะฟัะธ ัะฑะพัั
- โ **Progressive Retry** - ะพั ะฑัััััั ะฟะพะฒัะพัะพะฒ ะดะพ throttling ะฒ degraded mode
- โ **Exponential Backoff** - ะฟัะตะดะพัะฒัะฐัะตะฝะธะต "thundering herd"
- โ **Thread-Safety** - ะฑะตะทะพะฟะฐัะฝะฐั ัะฐะฑะพัะฐ ะธะท ะฝะตัะบะพะปัะบะธั ะฟะพัะพะบะพะฒ
- โ **Auto-Recovery** - ะฐะฒัะพะผะฐัะธัะตัะบะพะต ะฒะพัััะฐะฝะพะฒะปะตะฝะธะต ะฟัะธ ะฟะพัะฒะปะตะฝะธะธ PrintSrv
- โ **Observability** - ะดะตัะฐะปัะฝะพะต ะปะพะณะธัะพะฒะฐะฝะธะต ั ัะผะพะดะทะธ ะดะปั ะฑััััะพะน ะดะธะฐะณะฝะพััะธะบะธ

---

## ๐๏ธ ะััะธัะตะบัััะฐ

### State Machine (ะะพะฝะตัะฝัะน ะฐะฒัะพะผะฐั ัะพััะพัะฝะธะน)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ข ะจะขะะขะะซะ ะะะะะ           โ
โ  โข Polling ะบะฐะถะดัะต 500ms     โ
โ  โข consecutiveFailures = 0  โ
โ  โข Snapshot ะฐะบััะฐะปะตะฝ        โ
โโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโ
           โ
           โ 5 ะพัะธะฑะพะบ ะฟะพะดััะด
           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ก ะะะะะะะะะะฎะงะะะะ         โ
โ  โข invalidate() socket      โ
โ  โข 5 ะฟะพะฟััะพะบ ั backoff      โ
โ  โข 200ms โ 3200ms           โ
โโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโ
           โ
           โ ะัะต ะฟะพะฟััะบะธ ะธััะตัะฟะฐะฝั
           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ด ะะะกะกะขะะะะะะะะะ          โ
โ  โข ะัะพะฒะตัะบะฐ ะบะฐะถะดัะต 60 ัะตะบ   โ
โ  โข ะกัะฐััะน snapshot ะดะพัััะฟะตะฝ โ
โ  โข Auto-recovery ะฟัะธ ััะฟะตัะต โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ะะพะผะฟะพะฝะตะฝัั ัะธััะตะผั

#### 1. **SocketManager** (Connection Lifecycle)

- `getSocket()` - ะฒะพะทะฒัะฐัะฐะตั ะฒะฐะปะธะดะฝะพะต ัะพะตะดะธะฝะตะฝะธะต ะธะปะธ ัะพะทะดะฐะตั ะฝะพะฒะพะต
- `invalidate()` - ะฟัะธะฝัะดะธัะตะปัะฝะพ ะทะฐะบััะฒะฐะตั socket
- Thread-safe ัะตัะตะท `synchronized` + `volatile`

#### 2. **ScadaDataPollingService** (Retry Logic)

- `pollPrintSrvState()` - ะพัะฝะพะฒะฝะพะน ะผะตัะพะด ั @Scheduled
- `handleReconnection()` - retry ั ัะบัะฟะพะฝะตะฝัะธะฐะปัะฝัะผ backoff
- `handleRecoveryMode()` - throttling ะฒ degraded mode

#### 3. **PrintSrvSnapshotStore** (In-Memory Cache)

- `AtomicReference<QueryAllResponseDTO>` - thread-safe storage
- ะะปะธะตะฝัั ะฒัะตะณะดะฐ ะฟะพะปััะฐัั ะดะฐะฝะฝัะต (last valid snapshot)

---

## โ๏ธ ะะพะฝัะธะณััะฐัะธั (application.yaml)

```yaml
printsrv:
    ip: 127.0.0.1
    port: 10101
    retry:
        max-attempts: 5                    # ะะพะฟััะบะธ ะฟะตัะตะฟะพะดะบะปััะตะฝะธั
        initial-delay-ms: 200              # ะะฐัะฐะปัะฝะฐั ะทะฐะดะตัะถะบะฐ backoff
        max-delay-ms: 5000                 # ะะฐะบัะธะผะฐะปัะฝะฐั ะทะฐะดะตัะถะบะฐ (cap)
        recovery-check-interval-ms: 60000  # ะะฝัะตัะฒะฐะป ะฒ recovery mode (60 ัะตะบ)
    socket:
        connect-timeout-ms: 5000           # ะขะฐะนะผะฐัั ะฝะฐ ะฟะพะดะบะปััะตะฝะธะต
        read-timeout-ms: 5000              # ะขะฐะนะผะฐัั ะฝะฐ ััะตะฝะธะต
```

**Exponential Backoff ัะพัะผัะปะฐ:**

```
delay = min(initial-delay-ms * 2^(attempt-1), max-delay-ms)

ะะพะฟััะบะฐ 1: 0ms
ะะพะฟััะบะฐ 2: 200ms   (200 * 2^1 = 400ms)
ะะพะฟััะบะฐ 3: 400ms   (200 * 2^2 = 800ms)
ะะพะฟััะบะฐ 4: 800ms   (200 * 2^3 = 1600ms)
ะะพะฟััะบะฐ 5: 1600ms  (200 * 2^4 = 3200ms)

ะกัะผะผะฐัะฝะพะต ะฒัะตะผั: ~3 ัะตะบัะฝะดั
```

---

## ๐ ะะตะถะธะผั ัะฐะฑะพัั

### ๐ข ะะตะถะธะผ 1: ะจัะฐัะฝัะน (Normal Mode)

**ะฃัะปะพะฒะธั:** PrintSrv ะดะพัััะฟะตะฝ, ะฟะพัะปะตะดะฝะธะน ะทะฐะฟัะพั ััะฟะตัะตะฝ

**ะะพะฒะตะดะตะฝะธะต:**

- ะะฟัะพั ะบะฐะถะดัะต 500ms
- ะัะธ ะตะดะธะฝะธัะฝัั ะพัะธะฑะบะฐั - ะปะพะณะธัะพะฒะฐะฝะธะต ะธ ะพะถะธะดะฐะฝะธะต ัะปะตะดัััะตะณะพ ัะธะบะปะฐ
- `consecutiveFailures` ะธะฝะบัะตะผะตะฝัะธััะตััั, ะฝะพ ะฝะต ะดะพััะธะณะฐะตั ะฟะพัะพะณะฐ

**ะะพะณะธ:**

```
DEBUG: Starting PrintSrv polling cycle
DEBUG: Received snapshot from PrintSrv with 5 units
ERROR: โ Failed to poll PrintSrv (consecutive failures: 2)
DEBUG: Waiting for next polling cycle (in 500ms)...
```

---

### ๐ก ะะตะถะธะผ 2: ะะตัะตะฟะพะดะบะปััะตะฝะธะต (Reconnection Mode)

**ะขัะธะณะณะตั:** `consecutiveFailures >= 5`

**ะะปะณะพัะธัะผ:**

1. ะะฝะฒะฐะปะธะดะฐัะธั ัะตะบััะตะณะพ socket: `socketManager.invalidate()`
2. Retry loop ั ัะบัะฟะพะฝะตะฝัะธะฐะปัะฝัะผ backoff (5 ะฟะพะฟััะพะบ)
3. ะัะธ ััะฟะตัะต โ ััะฐัะฝัะน ัะตะถะธะผ
4. ะัะธ ะฝะตัะดะฐัะต โ ัะตะถะธะผ ะฒะพัััะฐะฝะพะฒะปะตะฝะธั

**ะะพะณะธ:**

```
WARN:  โ๏ธ ERROR THRESHOLD REACHED (5 failures) - initiating reconnection
INFO:  ๐ Starting reconnection procedure...
WARN:  โ๏ธ Invalidating socket connection to 127.0.0.1:10101
INFO:  ๐ Reconnection attempt 1/5 to PrintSrv...
ERROR: โ Reconnection attempt 1/5 failed: IOException
INFO:  โณ Waiting 400ms before retry attempt 2/5...
INFO:  ๐ Reconnection attempt 2/5 to PrintSrv...
INFO:  โ Reconnection successful on attempt 2/5
```

---

### ๐ด ะะตะถะธะผ 3: ะะพัััะฐะฝะพะฒะปะตะฝะธะต (Recovery Mode)

**ะฃัะปะพะฒะธั:** ะัะต 5 ะฟะพะฟััะพะบ ะฟะตัะตะฟะพะดะบะปััะตะฝะธั ะธััะตัะฟะฐะฝั

**ะะพะฒะตะดะตะฝะธะต:**

- `inRecoveryMode = true`
- ะัะพะฒะตัะบะฐ ะดะพัััะฟะฝะพััะธ ะบะฐะถะดัะต 60 ัะตะบัะฝะด (throttling)
- ะะปะธะตะฝัั ะฟัะพะดะพะปะถะฐัั ะฟะพะปััะฐัั ัััะฐัะตะฒัะธะน snapshot
- ะัะธ ััะฟะตัะฝะพะน ะฟัะพะฒะตัะบะต - ะฒััะพะด ะธะท ัะตะถะธะผะฐ ะธ ะฒะพะทะฒัะฐั ะบ ััะฐัะฝะพะผั

**ะะพะณะธ:**

```
ERROR: ๐จ ENTERING RECOVERY MODE - all reconnection attempts failed.
       Will check PrintSrv availability every 60 seconds.
       Clients continue to use last valid snapshot.
INFO:  ๐ Recovery mode: checking PrintSrv availability...
ERROR: โ Recovery check failed: PrintSrv still unavailable (next check in 60s)
...
INFO:  ๐ Recovery mode: checking PrintSrv availability...
INFO:  โ PrintSrv is AVAILABLE again - exiting recovery mode
```

---

## ๐ ะัะตะผะตะฝะฝัะต ัะฐัะฐะบัะตัะธััะธะบะธ

| ะกะพะฑััะธะต                | ะัะตะผั                         |
|------------------------|-------------------------------|
| ะะฑะฝะฐััะถะตะฝะธะต ะฟัะพะฑะปะตะผั   | 2.5 ัะตะบ (5 ร 500ms)           |
| ะะตัะตะฟะพะดะบะปััะตะฝะธะต (max)  | 3.0 ัะตะบ (5 ะฟะพะฟััะพะบ ั backoff) |
| ะัะพะด ะฒ recovery mode   | ~5.5 ัะตะบ ะพั ะฟะตัะฒะพะณะพ ัะฑะพั      |
| ะัะพะฒะตัะบะฐ ะฒ recovery    | 60 ัะตะบัะฝะด                     |
| ะะพัััะฐะฝะพะฒะปะตะฝะธะต (best)  | 500ms (ัะปะตะดัััะธะน poll)        |
| ะะพัััะฐะฝะพะฒะปะตะฝะธะต (worst) | 60 ัะตะบัะฝะด (ะฒ recovery)        |

---

## ๐ญ ะะฐัะฐะฝัะธะธ ะดะปั ะบะปะธะตะฝัะพะฒ REST API

### GET `/api/v1/commands/queryAll`

- โ **ะัะตะณะดะฐ ะฒะพะทะฒัะฐัะฐะตั 200 OK** (ะบัะพะผะต ะฟะตัะฒะพะณะพ ะทะฐะฟััะบะฐ - 503)
- โ **ะะธะบะพะณะดะฐ ะฝะต ะฒัะฑัะฐััะฒะฐะตั IOException** ะบะปะธะตะฝัั
- โ **ะะฐะฝะฝัะต ะฒัะตะณะดะฐ ะดะพัััะฟะฝั** (last valid snapshot)
- โ๏ธ **ะะพะณัั ะฑััั ัััะฐัะตะฒัะธะผะธ** ะฒ ัะตะถะธะผะต ะฒะพัััะฐะฝะพะฒะปะตะฝะธั

### POST `/api/v1/commands/setUnitVars`

- โ๏ธ **ะะพะบะฐ ะฑะตะท retry** - ะฒัะฑัะฐััะฒะฐะตั IOException ะฟัะธ ัะฑะพะต
- ๐ฎ **ะัะดััะตะต ัะปัััะตะฝะธะต:** ะธัะฟะพะปัะทะพะฒะฐะฝะธะต ัะพะน ะถะต retry-ะปะพะณะธะบะธ

---

## ๐ Thread-Safety

### ะัะธัะธัะตัะบะธะต ัะพัะบะธ:

1. **SocketManager.socket** - `volatile Socket` + `synchronized` ะผะตัะพะดั
2. **consecutiveFailures** - `AtomicInteger` (lock-free)
3. **inRecoveryMode** - `volatile boolean` (visibility)

### ะะฐัะฐะฝัะธะธ:

- โ ะะตั race conditions ะฟัะธ ัะพะทะดะฐะฝะธะธ/ะทะฐะบัััะธะธ socket
- โ ะัะพะผะฐัะฝัะต ะพะฟะตัะฐัะธะธ ัะพ ััะตััะธะบะฐะผะธ
- โ ะะธะดะธะผะพััั ะธะทะผะตะฝะตะฝะธะน ะผะตะถะดั ะฟะพัะพะบะฐะผะธ

---

## ๐ ะัััััะน ััะฐัั

### 1. ะะฐะฟััะบ ะฟัะธะปะพะถะตะฝะธั

```bash
cd backend
./gradlew bootRun
```

**ะะถะธะดะฐะตะผัะต ะปะพะณะธ:**

```
INFO: SocketManager initialized with PrintSrv address: 127.0.0.1:10101
INFO: ScadaDataPollingService initialized - polling interval: 500ms
DEBUG: Starting PrintSrv polling cycle
INFO: โ Socket connection established successfully
DEBUG: Received snapshot from PrintSrv with 5 units
```

### 2. ะัะพะฒะตัะบะฐ REST API

```bash
curl http://localhost:8080/api/v1/commands/queryAll
```

**ะะตะทัะปััะฐั:** 200 OK ั ะฐะบััะฐะปัะฝัะผะธ ะดะฐะฝะฝัะผะธ

### 3. ะะพะฝะธัะพัะธะฝะณ ะปะพะณะพะฒ

```bash
# Windows
Get-Content logs\spring.log -Wait | Select-String "โ|โ|โ๏ธ|๐จ"

# Linux/Mac
tail -f logs/spring.log | grep -E "(โ|โ|โ๏ธ|๐จ)"
```

---

## ๐งช ะกัะตะฝะฐัะธะธ ัะตััะธัะพะฒะฐะฝะธั

### ะขะตัั 1: ะจัะฐัะฝะฐั ัะฐะฑะพัะฐ โ

```
1. ะะฐะฟัััะธัะต PrintSrv
2. ะะฐะฟัััะธัะต Spring Backend
3. ะะฐะฑะปัะดะฐะนัะต ะปะพะณะธ ะบะฐะถะดัะต 500ms
4. ะัะพะฒะตัััะต REST API - ะดะพะปะถะตะฝ ะฒะตัะฝััั ะฐะบััะฐะปัะฝัะต ะดะฐะฝะฝัะต
```

### ะขะตัั 2: ะัะฐัะบะพะฒัะตะผะตะฝะฝัะน ัะฑะพะน (< 2.5 ัะตะบ) โ๏ธ

```
1. ะกะธััะตะผะฐ ัะฐะฑะพัะฐะตั ะฒ ััะฐัะฝะพะผ ัะตะถะธะผะต
2. ะััะฐะฝะพะฒะธัะต PrintSrv ะฝะฐ 2 ัะตะบัะฝะดั
3. ะะฐะฟัััะธัะต PrintSrv ะพะฑัะฐัะฝะพ

ะะถะธะดะฐะตะผัะต ะปะพะณะธ:
ERROR: โ Failed to poll PrintSrv (consecutive failures: 1-4)
INFO:  โ PrintSrv connection recovered after N consecutive failures

ะะตะทัะปััะฐั: ะะฒัะพะผะฐัะธัะตัะบะพะต ะฒะพัััะฐะฝะพะฒะปะตะฝะธะต ะฑะตะท ะฟะตัะตะฟะพะดะบะปััะตะฝะธั
```

### ะขะตัั 3: ะะปะธัะตะปัะฝัะน ัะฑะพะน โ ะะตัะตะฟะพะดะบะปััะตะฝะธะต ๐

```
1. ะกะธััะตะผะฐ ัะฐะฑะพัะฐะตั ะฒ ััะฐัะฝะพะผ ัะตะถะธะผะต
2. ะััะฐะฝะพะฒะธัะต PrintSrv ะฝะฐ 5 ัะตะบัะฝะด
3. ะะฐะฟัััะธัะต PrintSrv ะพะฑัะฐัะฝะพ

ะะถะธะดะฐะตะผัะต ะปะพะณะธ:
WARN:  โ๏ธ ERROR THRESHOLD REACHED - initiating reconnection
INFO:  ๐ Starting reconnection procedure...
INFO:  ๐ Reconnection attempt 1/5...
INFO:  โ Reconnection successful on attempt N/5

ะะตะทัะปััะฐั: Socket ะธะฝะฒะฐะปะธะดะธัะพะฒะฐะฝ ะธ ัะพะทะดะฐะฝ ะทะฐะฝะพะฒะพ
```

### ะขะตัั 4: PrintSrv ะฝะตะดะพัััะฟะตะฝ โ Recovery Mode ๐จ

```
1. ะกะธััะตะผะฐ ัะฐะฑะพัะฐะตั ะฒ ััะฐัะฝะพะผ ัะตะถะธะผะต
2. ะััะฐะฝะพะฒะธัะต PrintSrv ะฝะฐัะพะฒัะตะผ

ะะถะธะดะฐะตะผัะต ะปะพะณะธ (ัะตัะตะท ~5.5 ัะตะบ):
ERROR: ๐จ ENTERING RECOVERY MODE
INFO:  ๐ Recovery mode: checking PrintSrv availability...
ERROR: โ Recovery check failed (next check in 60s)

REST API:
curl http://localhost:8080/api/v1/commands/queryAll
โ 200 OK (ัััะฐัะตะฒัะธะน snapshot)

ะะตะทัะปััะฐั: Graceful degradation, ะบะปะธะตะฝัั ะฝะต ะฒะธะดัั ะพัะธะฑะพะบ
```

### ะขะตัั 5: ะะพัััะฐะฝะพะฒะปะตะฝะธะต ะธะท Recovery Mode โ

```
1. ะะพะฒะตะดะธัะต ัะธััะตะผั ะดะพ Recovery Mode (ัะตัั 4)
2. ะะพะดะพะถะดะธัะต ะดะพ ัะปะตะดัััะตะน ะฟัะพะฒะตัะบะธ (ะดะพ 60 ัะตะบ)
3. ะะฐะฟัััะธัะต PrintSrv ะฟะตัะตะด ะฟัะพะฒะตัะบะพะน

ะะถะธะดะฐะตะผัะต ะปะพะณะธ:
INFO: ๐ Recovery mode: checking PrintSrv availability...
INFO: โ PrintSrv is AVAILABLE again - exiting recovery mode

ะะตะทัะปััะฐั: ะะฒัะพะผะฐัะธัะตัะบะธะน ะฒะพะทะฒัะฐั ะฒ ััะฐัะฝัะน ัะตะถะธะผ
```

---

## ๐ ะญะผะพะดะทะธ ะปะตะณะตะฝะดะฐ ะดะปั ะปะพะณะพะฒ

| ะญะผะพะดะทะธ | ะะฝะฐัะตะฝะธะต                            | Severity |
|--------|-------------------------------------|----------|
| โ      | ะฃัะฟะตัะฝะฐั ะพะฟะตัะฐัะธั / ะฒะพัััะฐะฝะพะฒะปะตะฝะธะต  | INFO     |
| โ      | ะัะธะฑะบะฐ ะพะฟะตัะฐัะธะธ                     | ERROR    |
| โ๏ธ     | ะัะตะดัะฟัะตะถะดะตะฝะธะต / ะดะพััะธะถะตะฝะธะต ะฟะพัะพะณะฐ  | WARN     |
| ๐     | ะะฐัะฐะปะพ ะฟัะพัะตััะฐ ะฟะตัะตะฟะพะดะบะปััะตะฝะธั     | INFO     |
| ๐     | ะะพะฟััะบะฐ ะฟะพะดะบะปััะตะฝะธั                 | INFO     |
| โณ      | ะะถะธะดะฐะฝะธะต ะฟะตัะตะด retry                | INFO     |
| ๐จ     | ะัะธัะธัะตัะบะพะต ัะพะฑััะธะต (recovery mode) | ERROR    |
| ๐     | ะัะพะฒะตัะบะฐ ะดะพัััะฟะฝะพััะธ ะฒ recovery     | INFO     |

---

## ๐ Troubleshooting

### ะัะพะฑะปะตะผะฐ: "PrintSrv snapshot not available yet"

**ะกะธะผะฟัะพะผั:**

```
GET /api/v1/commands/queryAll โ 503 Service Unavailable
```

**ะัะธัะธะฝะฐ:** ะัะธะปะพะถะตะฝะธะต ัะพะปัะบะพ ะทะฐะฟัััะธะปะพัั, ะฟะตัะฒัะน snapshot ะตัะต ะฝะต ะทะฐะณััะถะตะฝ  
**ะะตัะตะฝะธะต:** ะะพะดะพะถะดะธัะต 1-2 ัะตะบัะฝะดั ะธ ะฟะพะฒัะพัะธัะต ะทะฐะฟัะพั

---

### ะัะพะฑะปะตะผะฐ: ะกะธััะตะผะฐ ััะฐะทั ะฒัะพะดะธั ะฒ recovery mode

**ะกะธะผะฟัะพะผั:**

```
ERROR: ๐จ ENTERING RECOVERY MODE (ััะฐะทั ะฟะพัะปะต ััะฐััะฐ)
```

**ะัะธัะธะฝะฐ:** PrintSrv ะฝะต ะทะฐะฟััะตะฝ ะธะปะธ ะฝะตะดะพัััะฟะตะฝ  
**ะะตัะตะฝะธะต:**

1. ะัะพะฒะตัััะต, ััะพ PrintSrv ะทะฐะฟััะตะฝ: `netstat -an | findstr 10101`
2. ะัะพะฒะตัััะต ะบะพะฝัะธะณััะฐัะธั `printsrv.ip` ะธ `printsrv.port`
3. ะัะพะฒะตัััะต firewall ะฝะฐัััะพะนะบะธ

---

### ะัะพะฑะปะตะผะฐ: ะะพะณะธ "Socket closed" ะฟัะธ ะบะฐะถะดะพะผ ะทะฐะฟัะพัะต

**ะกะธะผะฟัะพะผั:**

```
ERROR: Attempted to send request but socket is closed
```

**ะัะธัะธะฝะฐ:** SocketManager ะฝะต ะผะพะถะตั ัะพะทะดะฐัั ัะพะตะดะธะฝะตะฝะธะต  
**ะะตัะตะฝะธะต:**

1. ะฃะฑะตะดะธัะตัั, ััะพ PrintSrv ัะปััะฐะตั ะฝะฐ 127.0.0.1:10101
2. ะัะพะฒะตัััะต firewall
3. ะฃะฒะตะปะธัััะต ัะฐะนะผะฐััั ะฒ `application.yaml`

---

## ๐ง ะะฐัััะพะนะบะฐ ะดะปั ัะฐะทะฝัั ะพะบััะถะตะฝะธะน

### Development (ะฑััััะฐั ะพัะปะฐะดะบะฐ)

```yaml
printsrv:
    retry:
        max-attempts: 3
        initial-delay-ms: 100
        recovery-check-interval-ms: 10000  # 10 ัะตะบัะฝะด
    socket:
        connect-timeout-ms: 2000
        read-timeout-ms: 2000

logging:
    level:
        dev.savushkin.scada.mobile.backend: TRACE  # ะะตัะฐะปัะฝัะต ะปะพะณะธ
```

### Production (ะพะฟัะธะผะธะทะธัะพะฒะฐะฝะฝะฐั ะฝะฐัััะพะนะบะฐ)

```yaml
printsrv:
    retry:
        max-attempts: 5
        initial-delay-ms: 200
        recovery-check-interval-ms: 60000  # 60 ัะตะบัะฝะด
    socket:
        connect-timeout-ms: 5000
        read-timeout-ms: 5000

logging:
    level:
        dev.savushkin.scada.mobile.backend: INFO  # ะขะพะปัะบะพ ะฒะฐะถะฝัะต ัะพะฑััะธั
```

---

## ๐ ะะตััะธะบะธ ะดะปั ะผะพะฝะธัะพัะธะฝะณะฐ

### ะะปััะตะฒัะต ะฟะพะบะฐะทะฐัะตะปะธ:

- `consecutiveFailures.get()` - ัะตะบััะตะต ะบะพะปะธัะตััะฒะพ ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝัั ะพัะธะฑะพะบ
- `inRecoveryMode` - ัะปะฐะณ degraded ัะพััะพัะฝะธั

### ะะปะตััั ะดะปั production:

- `consecutiveFailures >= 3` โ Warning (PrintSrv ะฝะฐัะธะฝะฐะตั "ะฑะฐัะฐัะปะธัั")
- `inRecoveryMode == true` โ Critical (PrintSrv ะฝะตะดะพัััะฟะตะฝ > 5 ัะตะบัะฝะด)

---

## ๐ ะััะธัะตะบัััะฝัะต ะฟัะธะฝัะธะฟั

โ **Single Responsibility** - ะบะฐะถะดัะน ะบะพะผะฟะพะฝะตะฝั ะพัะฒะตัะฐะตั ะทะฐ ะพะดะฝะพ  
โ **Separation of Concerns** - retry ะพัะดะตะปะตะฝ ะพั connection management  
โ **Configuration over Code** - ะฒัะต ะฟะฐัะฐะผะตััั ะฒ YAML  
โ **Fail-Safe Defaults** - ัะฐะทัะผะฝัะต ะทะฝะฐัะตะฝะธั ะฟะพ ัะผะพะปัะฐะฝะธั  
โ **Observability First** - ะดะตัะฐะปัะฝะพะต ะปะพะณะธัะพะฒะฐะฝะธะต  
โ **Graceful Degradation** - ัะธััะตะผะฐ ะฝะธะบะพะณะดะฐ ะฝะต ะฟะฐะดะฐะตั  
โ **Thread-Safety** - synchronized + atomic + volatile  
โ **Testability** - dependency injection, ะฟะฐัะฐะผะตััะธะทะฐัะธั

---

## ๐ฆ ะะทะผะตะฝะตะฝะฝัะต ัะฐะนะปั

### Code changes (3 ัะฐะนะปะฐ)

1. `SocketManager.java` - +60 ัััะพะบ (connection management + invalidation)
2. `ScadaDataPollingService.java` - +250 ัััะพะบ (retry logic + state machine)
3. `application.yaml` - +12 ัััะพะบ (configuration)

---

## ๐ฎ ะัะดััะธะต ัะปัััะตะฝะธั (ะพะฟัะธะพะฝะฐะปัะฝะพ)

- [ ] Retry ะดะปั SetUnitVars REST handler
- [ ] Spring Boot Actuator health endpoint
- [ ] Prometheus metrics (consecutive failures, recovery mode)
- [ ] Grafana dashboard
- [ ] Circuit Breaker pattern (Resilience4j)
- [ ] Adaptive backoff ะฝะฐ ะพัะฝะพะฒะต ะธััะพัะธะธ ะพัะธะฑะพะบ
- [ ] ะะปะตััั ะฒ Slack/Email ะฟัะธ recovery mode

---

## โ ะัะพะณ

**Production-ready retry-ะผะตัะฐะฝะธะทะผ** ั:

- โ ะขัะตัััะพะฒะฝะตะฒะพะน ัััะฐัะตะณะธะตะน ะพะฑัะฐะฑะพัะบะธ ะพัะธะฑะพะบ
- โ ะญะบัะฟะพะฝะตะฝัะธะฐะปัะฝัะผ backoff (200ms โ 3200ms)
- โ Graceful degradation ะดะปั ะบะปะธะตะฝัะพะฒ
- โ Thread-safety ะดะปั concurrent ะดะพัััะฟะฐ
- โ ะะตัะฐะปัะฝะพะน observability (ัะผะพะดะทะธ ะปะพะณะธ)
- โ ะะพะฝัะธะณััะธััะตะผะพัััั ัะตัะตะท YAML

**ะะพัะพะฒะพ ะบ ะธัะฟะพะปัะทะพะฒะฐะฝะธั!** ๐

---

**ะะตะฐะปะธะทะพะฒะฐะฝะพ:** GitHub Copilot  
**ะะฐัะฐ:** 2026-02-08  
**ะะตััะธั:** 2.0 (ะพะฑะฝะพะฒะปะตะฝ initial-delay-ms: 200)  
**ะกัะฐััั:** โ PRODUCTION READY

