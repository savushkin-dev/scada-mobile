# Scan Cycle Architecture Implementation Checklist

> **ะฆะตะปั:** ะะทะพะปะธัะพะฒะฐัั ะบะปะธะตะฝัะพะฒ ะพั PrintSrv ัะตัะตะท snapshot ั ัะธะฝััะพะฝะฝัะผ ัะธะบะปะพะผ ััะตะฝะธะตโะปะพะณะธะบะฐโะทะฐะฟะธัั

> **ะััะธัะตะบัััะฝัะน ะฟัะธะฝัะธะฟ:** ะะดะธะฝ ะฟะพัะพะบ ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพ ะฒัะฟะพะปะฝัะตั: READ ะธะท PrintSrv โ BUSINESS LOGIC โ WRITE ะฒ
> PrintSrv โ UPDATE snapshot. ะญัะพ ะธัะบะปััะฐะตั race conditions ะธ ัะพะพัะฒะตัััะฒัะตั ะฟัะพะผััะปะตะฝะฝัะผ ััะฐะฝะดะฐััะฐะผ SCADA.

---

## ๐๏ธ ะััะธัะตะบัััะฝะฐั ะดะธะฐะณัะฐะผะผะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ะะะะะซะ ะฆะะะ ะกะะะะะะะะะะะฏ (ะบะฐะถะดัะต 5 ัะตะบัะฝะด)          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ
        โโโโโโโโโโโโโโโโโโโโโโโโโ
        โ [1] READ ะธะท PrintSrv  โ โ QueryAllCommand
        โโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ [2] BUSINESS LOGIC            โ
        โ  โข ะกะปะธัะฝะธะต ั pending ะบะพะผะฐะฝะดะฐะผะธโ
        โ  โข ะะฐะปะธะดะฐัะธั                  โ
        โ  โข ะััะธัะปะตะฝะธั                 โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ
        โโโโโโโโโโโโโโโโโโโโโโโโโ
        โ [3] WRITE ะฒ PrintSrv  โ โ SetUnitVarsCommand
        โโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ
        โโโโโโโโโโโโโโโโโโโโโโโโโ
        โ [4] UPDATE snapshot   โ โ PrintSrvSnapshotStore
        โโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ
              โ ะะพะฒัะพั ัะธะบะปะฐ

โโโโโโโโโโโโโโโโโโโโโโโ
โ ะะปะธะตะฝั POST /set    โ โ ะะพะฑะฐะฒะปัะตั ะบะพะผะฐะฝะดั ะฒ ะฑััะตั
โโโโโโโโโโโโโโโโโโโโโโโ   (ะะ ะฒ snapshot!)

โโโโโโโโโโโโโโโโโโโโโโโ
โ ะะปะธะตะฝั GET /query   โ โ ะงะธัะฐะตั snapshot
โโโโโโโโโโโโโโโโโโโโโโโ   (ะฐะบััะฐะปัะฝัะต ะดะฐะฝะฝัะต ะฟะพัะปะต ะฟะพัะปะตะดะฝะตะณะพ ัะธะบะปะฐ)
```

---

## ๐ ะคะฐะทะฐ 1: ะััะตั ะบะปะธะตะฝััะบะธั ะบะพะผะฐะฝะด

### โ ะะฐะดะฐัะฐ 1.1: ะกะพะทะดะฐัั ะผะพะดะตะปั ะบะพะผะฐะฝะดั

**ะกะพะทะดะฐัั ัะฐะนะป:** `store/PendingWriteCommand.java`

**ะกัััะบัััะฐ:**

```java
public record PendingWriteCommand(
    long timestamp,                    // ะัะตะผั ัะพะทะดะฐะฝะธั ะบะพะผะฐะฝะดั
    int unit,                          // ะะพะผะตั ัะฝะธัะฐ (1-based)
    Map<String, Object> properties     // ะะทะผะตะฝัะตะผัะต ัะฒะพะนััะฒะฐ {"command": 999}
) {
    public PendingWriteCommand(int unit, Map<String, Object> properties) {
        this(System.currentTimeMillis(), unit, properties);
    }
}
```

**ะะฐะถะฝะพ:**

- ะัะพััะฐั immutable ััััะบัััะฐ (ะฑะตะท ััะฐัััะพะฒ ะธ retry-ััะตััะธะบะพะฒ)
- ะะพะผะฐะฝะดั ะถะธะฒัั ัะพะปัะบะพ ะดะพ ัะปะตะดัััะตะณะพ ัะธะบะปะฐ ัะบะฐะฝะธัะพะฒะฐะฝะธั

---

### โ ะะฐะดะฐัะฐ 1.2: ะกะพะทะดะฐัั ะฑััะตั ะบะพะผะฐะฝะด

**ะกะพะทะดะฐัั ัะฐะนะป:** `store/PendingCommandsBuffer.java`

**ะกัััะบัััะฐ:**

```java
@Component
public class PendingCommandsBuffer {
    // Map<unitId, PendingWriteCommand>
    // ConcurrentHashMap ะดะปั thread-safety ะผะตะถะดั REST-ะบะพะฝััะพะปะปะตัะพะผ ะธ scan cycle
    private final ConcurrentHashMap<Integer, PendingWriteCommand> buffer = new ConcurrentHashMap<>();
    
    private static final int MAX_BUFFER_SIZE = 100;
    
    public void add(PendingWriteCommand command) { ... }
    public Map<Integer, PendingWriteCommand> getAndClear() { ... }
    public boolean isEmpty() { ... }
    public int size() { ... }
}
```

**ะะพะณะธะบะฐ `add()`:**

```java
if (buffer.size() >= MAX_BUFFER_SIZE) {
    throw new IllegalStateException("ะััะตั ะบะพะผะฐะฝะด ะฟะตัะตะฟะพะปะฝะตะฝ");
}
buffer.put(command.unit(), command);
```

**ะะพะณะธะบะฐ `getAndClear()`:**

```java
Map<Integer, PendingWriteCommand> snapshot = new HashMap<>(buffer);
buffer.clear();
return snapshot;
```

**ะะพัะตะผั Map, ะฐ ะฝะต Queue:**

- ะัะปะธ ะบะปะธะตะฝั ะพัะฟัะฐะฒะธะป ะฝะตัะบะพะปัะบะพ ะบะพะผะฐะฝะด ะดะปั ะพะดะฝะพะณะพ unit โ ัะพััะฐะฝัะตััั ัะพะปัะบะพ ะฟะพัะปะตะดะฝัั (Last-Write-Wins)
- ะฃะฟัะพัะฐะตั ะปะพะณะธะบั ัะปะธัะฝะธั (ะฝะตั ะดัะฑะปะธะบะฐัะพะฒ ะฟะพ unit)

---

## ๐ ะคะฐะทะฐ 2: ะะพะดะธัะธะบะฐัะธั ScadaDataPollingService

### โ ะะฐะดะฐัะฐ 2.1: ะะฝะตะดัะธัั ะทะฐะฒะธัะธะผะพััะธ

**ะคะฐะนะป:** `ScadaDataPollingService.java`

**ะะพะฑะฐะฒะธัั ะฒ ะบะพะฝััััะบัะพั:**

```java
private final PendingCommandsBuffer pendingCommandsBuffer;
private final SetUnitVars setUnitVarsCommand;
```

---

### โ ะะฐะดะฐัะฐ 2.2: ะะตัะตะฟะธัะฐัั ะผะตัะพะด pollAndUpdateSnapshot()

**ะคะฐะนะป:** `ScadaDataPollingService.java`

**ะะตัะตะธะผะตะฝะพะฒะฐัั ะผะตัะพะด:** `pollAndUpdateSnapshot()` โ `scanCycle()`

**ะะพะฒะฐั ะปะพะณะธะบะฐ ะผะตัะพะดะฐ `scanCycle()`:**

```java
@Scheduled(fixedRate = 5000)
public void scanCycle() {
    try {
        // [1] READ ะธะท PrintSrv
        QueryAllResponseDTO freshData = queryAllCommand.execute(
            new QueryAllRequestDTO(/* ะฟะฐัะฐะผะตััั */)
        );
        
        // [2] BUSINESS LOGIC - ะฟะพะปััะธัั pending ะบะพะผะฐะฝะดั
        Map<Integer, PendingWriteCommand> pendingWrites = 
            pendingCommandsBuffer.getAndClear();
        
        // [3] WRITE ะฒ PrintSrv (ะตัะปะธ ะตััั ะบะพะผะฐะฝะดั)
        if (!pendingWrites.isEmpty()) {
            SetUnitVarsRequestDTO writeRequest = buildWriteRequest(pendingWrites);
            
            try {
                setUnitVarsCommand.execute(writeRequest);
            } catch (IOException e) {
                // ะะพะณะธัะพะฒะฐัั ะพัะธะฑะบั ะทะฐะฟะธัะธ
                // ะะพะผะฐะฝะดั ะฟะพัะตััะฝั (ะบะปะธะตะฝั ะฟะพะปััะธั ััะฐัะพะต ะทะฝะฐัะตะฝะธะต ะฒ ัะปะตะดัััะตะผ ัะธะบะปะต)
            }
        }
        
        // [4] UPDATE snapshot (ะฝะตะทะฐะฒะธัะธะผะพ ะพั ััะฟะตัะฐ ะทะฐะฟะธัะธ)
        // Snapshot = ะธััะพัะฝะธะบ ะฟัะฐะฒะดั (ะดะฐะฝะฝัะต ะธะท PrintSrv)
        snapshotStore.saveSnapshot(freshData);
        
    } catch (IOException e) {
        // ะะพะณะธัะพะฒะฐัั ะพัะธะฑะบั ััะตะฝะธั PrintSrv
        // Snapshot ะฝะต ะพะฑะฝะพะฒะปัะตััั (ะบะปะธะตะฝัั ะฟะพะปััะฐั ัััะฐัะตะฒัะธะต ะดะฐะฝะฝัะต)
    }
}
```

---

### โ ะะฐะดะฐัะฐ 2.3: ะะพะฑะฐะฒะธัั ะฒัะฟะพะผะพะณะฐัะตะปัะฝัะน ะผะตัะพะด

**ะคะฐะนะป:** `ScadaDataPollingService.java`

**ะะพะฑะฐะฒะธัั ะผะตัะพะด:**

```java
private SetUnitVarsRequestDTO buildWriteRequest(
    Map<Integer, PendingWriteCommand> pendingWrites
) {
    Map<String, UnitsDTO> units = new HashMap<>();
    
    for (PendingWriteCommand cmd : pendingWrites.values()) {
        String unitKey = "u" + cmd.unit();
        UnitsDTO unitDTO = new UnitsDTO(
            new PropertiesDTO(cmd.properties()),
            null  // parameters ะฝะต ะผะตะฝัะตะผ
        );
        units.put(unitKey, unitDTO);
    }
    
    return new SetUnitVarsRequestDTO(units);
}
```

**ะะฐะถะฝะพ:**

- ะัะตะพะฑัะฐะทะพะฒะฐะฝะธะต `int unit` โ `String "u" + unit` (ัะพะพัะฒะตัััะฒะธะต ัะพัะผะฐัั PrintSrv)
- ะัะฟัะฐะฒะปััััั ัะพะปัะบะพ ะธะทะผะตะฝัะตะผัะต properties

---

## ๐ ะคะฐะทะฐ 3: ะะพะดะธัะธะบะฐัะธั CommandsService

### โ ะะฐะดะฐัะฐ 3.1: ะะฝะตะดัะธัั ะทะฐะฒะธัะธะผะพััะธ

**ะคะฐะนะป:** `CommandsService.java`

**ะะฐะผะตะฝะธัั ะทะฐะฒะธัะธะผะพััั:**

```java
// ะฃะดะฐะปะธัั: private final SetUnitVars setUnitVarsCommand;
// ะะพะฑะฐะฒะธัั:
private final PendingCommandsBuffer pendingCommandsBuffer;
```

---

### โ ะะฐะดะฐัะฐ 3.2: ะะตัะตะฟะธัะฐัั ะผะตัะพะด setUnitVars()

**ะคะฐะนะป:** `CommandsService.java`

**ะะพะฒะฐั ะปะพะณะธะบะฐ ะผะตัะพะดะฐ `setUnitVars(int unit, int value)`:**

```java
public SetUnitVarsResponseDTO setUnitVars(int unit, int value) {
    // 1. ะกะพะทะดะฐัั ะบะพะผะฐะฝะดั
    PendingWriteCommand command = new PendingWriteCommand(
        unit,
        Map.of("command", value)
    );
    
    // 2. ะะพะฑะฐะฒะธัั ะฒ ะฑััะตั (ะฑัะดะตั ะพะฑัะฐะฑะพัะฐะฝะฐ ะฒ ัะปะตะดัััะตะผ scan cycle)
    pendingCommandsBuffer.add(command);
    
    // 3. ะะตัะฝััั acknowledge-ะพัะฒะตั (ะะะ ะดะฐะฝะฝัั ะธะท snapshot)
    // ะะปะธะตะฝั ัะทะฝะฐะตั ัะตะทัะปััะฐั ะฟัะธ ัะปะตะดัััะตะผ GET /query-all
    return new SetUnitVarsResponseDTO(
        Map.of("u" + unit, new UnitsDTO(
            new PropertiesDTO(Map.of("command", value)),
            null
        ))
    );
}
```

**ะะปััะตัะฝะฐัะธะฒะฐ (ะตัะปะธ ะฝัะถะตะฝ ะผะธะฝะธะผะฐะปัะฝัะน ะพัะฒะตั):**

```java
// ะะตัะฝััั ะฟัััะพะน ะพัะฒะตั ั HTTP 202 Accepted
return new SetUnitVarsResponseDTO(Map.of());
```

**ะะฐะถะฝะพ:**

- ะะปะธะตะฝั ะะ ะฟะพะปััะฐะตั ะฐะบััะฐะปัะฝัะต ะดะฐะฝะฝัะต ะธะท snapshot
- ะัะฒะตั = ะฟะพะดัะฒะตัะถะดะตะฝะธะต ะฟัะธะตะผะฐ ะบะพะผะฐะฝะดั
- ะะตะฐะปัะฝะพะต ะทะฝะฐัะตะฝะธะต ะบะปะธะตะฝั ัะฒะธะดะธั ะฟะพัะปะต ัะปะตะดัััะตะณะพ scan cycle (ะดะพ 5 ัะตะบัะฝะด ะทะฐะดะตัะถะบะธ)

---

## ๐ ะคะฐะทะฐ 4: ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ ะธ ะณัะฐะฝะธัะฝัะต ัะปััะฐะธ

### โ ะะฐะดะฐัะฐ 4.1: ะะฑัะฐะฑะพัะบะฐ ะฝะตะดะพัััะฟะฝะพััะธ PrintSrv

**ะคะฐะนะป:** `ScadaDataPollingService.java`

**ะะพะณะธะบะฐ ะฟัะธ IOException ะฒ `scanCycle()`:**

```java
catch (IOException e) {
    // READ failed - PrintSrv ะฝะตะดะพัััะฟะตะฝ
    // Snapshot ะะ ะพะฑะฝะพะฒะปัะตััั โ ะบะปะธะตะฝัั ะฟะพะปััะฐัั stale data
    // Pending ะบะพะผะฐะฝะดั ะพััะฐัััั ะฒ ะฑััะตัะต ะดะพ ัะปะตะดัััะตะณะพ ัะธะบะปะฐ
    // ะะพะณะธัะพะฒะฐัั: "PrintSrv ะฝะตะดะพัััะฟะตะฝ, ะฟะพะฒัะพั ัะตัะตะท 5 ัะตะบัะฝะด"
}
```

**ะะฐะถะฝะพ:**

- ะะพะผะฐะฝะดั ะะ ัะตัััััั ะฟัะธ ะฒัะตะผะตะฝะฝะพะน ะฝะตะดะพัััะฟะฝะพััะธ
- ะััะตั ะฝะฐะบะฐะฟะปะธะฒะฐะตั ะบะพะผะฐะฝะดั (ะดะพ MAX_BUFFER_SIZE)
- ะัะธ ะฒะพัััะฐะฝะพะฒะปะตะฝะธะธ PrintSrv ะฒัะต ะบะพะผะฐะฝะดั ะฑัะดัั ะทะฐะฟะธัะฐะฝั

---

### โ ะะฐะดะฐัะฐ 4.2: ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ ะทะฐะฟะธัะธ

**ะคะฐะนะป:** `ScadaDataPollingService.java`

**ะะพะณะธะบะฐ ะฟัะธ IOException ะฒ ะฑะปะพะบะต WRITE:**

```java
try {
    setUnitVarsCommand.execute(writeRequest);
} catch (IOException e) {
    // WRITE failed - ะบะพะผะฐะฝะดั ะฟะพัะตััะฝั
    // PrintSrv ะฝะต ะฟะพะปััะธะป ะฝะพะฒัะต ะทะฝะฐัะตะฝะธั
    // Snapshot ะพะฑะฝะพะฒะธััั ะธะท READ (ััะฐััะต ะทะฝะฐัะตะฝะธั)
    // ะะพะณะธัะพะฒะฐัั: "ะัะธะฑะบะฐ ะทะฐะฟะธัะธ ะฒ PrintSrv, ะบะพะผะฐะฝะดั ะฟะพัะตััะฝั: {unitIds}"
}
```

**ะะพัะตะผั ะบะพะผะฐะฝะดั ัะตัััััั:**

- ะะตั retry-ะผะตัะฐะฝะธะทะผะฐ (ะฟะพ ัะพะณะปะฐัะพะฒะฐะฝะธั ั ััะบะพะฒะพะดะธัะตะปะตะผ)
- ะฃะฟัะพัะตะฝะธะต ะฐััะธัะตะบัััั
- ะะปะธะตะฝั ะผะพะถะตั ะฟะพะฒัะพัะธัั ะทะฐะฟัะพั

---

### โ ะะฐะดะฐัะฐ 4.3: ะะณัะฐะฝะธัะตะฝะธะต ัะฐะทะผะตัะฐ ะฑััะตัะฐ

**ะคะฐะนะป:** `PendingCommandsBuffer.java`

**ะะพะฑะฐะฒะธัั ะฒ ะผะตัะพะด `add()`:**

```java
if (buffer.size() >= MAX_BUFFER_SIZE) {
    throw new IllegalStateException(
        "ะััะตั ะบะพะผะฐะฝะด ะฟะตัะตะฟะพะปะฝะตะฝ. PrintSrv ะฝะตะดะพัััะฟะตะฝ ะดะปะธัะตะปัะฝะพะต ะฒัะตะผั."
    );
}
```

**ะะฑัะฐะฑะพัะบะฐ ะฒ ะบะพะฝััะพะปะปะตัะต:**

```java
@ExceptionHandler(IllegalStateException.class)
public ResponseEntity<ErrorResponseDTO> handleBufferOverflow(IllegalStateException e) {
    return ResponseEntity
        .status(HttpStatus.SERVICE_UNAVAILABLE)
        .body(new ErrorResponseDTO(e.getMessage()));
}
```

---

## ๐ ะคะฐะทะฐ 5: Thread Safety ะธ ัะธะฝััะพะฝะธะทะฐัะธั

### โ ะะฐะดะฐัะฐ 5.1: ะะฝะฐะปะธะท ะฟะพัะพะบะพะฒ

**ะะพัะพะบะธ ะฒ ัะธััะตะผะต:**

1. **REST Thread Pool** (Tomcat) โ ะพะฑัะฐะฑะฐััะฒะฐะตั ะบะปะธะตะฝััะบะธะต ะทะฐะฟัะพัั
2. **Scheduler Thread** โ ะฒัะฟะพะปะฝัะตั `scanCycle()` ะบะฐะถะดัะต 5 ัะตะบัะฝะด

**ะขะพัะบะธ ะบะพะฝะบััะตะฝัะธะธ:**

- `PendingCommandsBuffer.add()` โ ะฒัะทัะฒะฐะตััั ะธะท REST
- `PendingCommandsBuffer.getAndClear()` โ ะฒัะทัะฒะฐะตััั ะธะท Scheduler

**ะะตัะตะฝะธะต:** `ConcurrentHashMap` ะพะฑะตัะฟะตัะธะฒะฐะตั thread-safety

---

### โ ะะฐะดะฐัะฐ 5.2: ะะฐัะฐะฝัะธะธ ะฑะตะทะพะฟะฐัะฝะพััะธ

**PrintSrvSnapshotStore:**

- โ Thread-safe (AtomicReference)
- โ ะัะฟะพะปัะทัะตััั ัะพะปัะบะพ Scheduler ะดะปั ะทะฐะฟะธัะธ
- โ ะัะฟะพะปัะทัะตััั REST threads ะดะปั ััะตะฝะธั (immutable snapshot)

**PendingCommandsBuffer:**

- โ Thread-safe (ConcurrentHashMap)
- โ `getAndClear()` ะฐัะพะผะฐัะฝะพ ะพัะธัะฐะตั ะฑััะตั
- โ ะะพะผะฐะฝะดั, ะดะพะฑะฐะฒะปะตะฝะฝัะต ะฒะพ ะฒัะตะผั `getAndClear()`, ะฟะพะฟะฐะดัั ะฒ ัะปะตะดัััะธะน ัะธะบะป

**ะะตั ะฝะตะพะฑัะพะดะธะผะพััะธ ะฒ:**

- โ ะะปะพะบะธัะพะฒะบะฐั (locks)
- โ ะกะธะฝััะพะฝะธะทะฐัะธะธ ะผะตัะพะดะพะฒ
- โ Volatile ะฟะพะปัั (ะธัะฟะพะปัะทัะตััั AtomicReference)

---

## ๐ ะขะตััะธัะพะฒะฐะฝะธะต

### โ ะขะตัั 1: ะะฐะทะพะฒัะน ััะตะฝะฐัะธะน

**ะจะฐะณะธ:**

1. ะะฐะฟัััะธัั ะฟัะธะปะพะถะตะฝะธะต
2. ะะพะถะดะฐัััั ะฟะตัะฒะพะณะพ snapshot (ะฟัะพะฒะตัะธัั ะปะพะณะธ: "Snapshot ะพะฑะฝะพะฒะปะตะฝ")
3. ะัะฟัะฐะฒะธัั: `POST /commands/set?unit=1&value=999`
4. ะกัะฐะทั ะพัะฟัะฐะฒะธัั: `GET /commands/query-all`
5. **ะะถะธะดะฐะฝะธะต:** ะัะฒะตั ัะพะดะตัะถะธั **ััะฐัะพะต** ะทะฝะฐัะตะฝะธะต (snapshot ะตัะต ะฝะต ะพะฑะฝะพะฒะปะตะฝ)
6. ะะพะดะพะถะดะฐัั 5+ ัะตะบัะฝะด (ัะปะตะดัััะธะน scan cycle)
7. ะัะฟัะฐะฒะธัั: `GET /commands/query-all`
8. **ะะถะธะดะฐะฝะธะต:** ะัะฒะตั ัะพะดะตัะถะธั `command: 999`
9. ะัะพะฒะตัะธัั PrintSrv UI โ ะดะพะปะถะฝะพ ะฑััั `command: 999`

**ะัะธัะตัะธะธ ััะฟะตัะฐ:**

- โ ะะพะผะฐะฝะดะฐ ะดะพัะปะฐ ะดะพ PrintSrv
- โ Snapshot ะพะฑะฝะพะฒะธะปัั ะฟะพัะปะต ัะธะบะปะฐ
- โ ะะตั ะพัะธะฑะพะบ ะฒ ะปะพะณะฐั

---

### โ ะขะตัั 2: ะะตะดะพัััะฟะฝะพััั PrintSrv

**ะจะฐะณะธ:**

1. ะััะฐะฝะพะฒะธัั PrintSrv
2. ะัะฟัะฐะฒะธัั: `POST /commands/set?unit=1&value=111`
3. ะัะฟัะฐะฒะธัั: `POST /commands/set?unit=2&value=222`
4. ะัะพะฒะตัะธัั ะปะพะณะธ ัะตัะตะท 5 ัะตะบัะฝะด: "PrintSrv ะฝะตะดะพัััะฟะตะฝ"
5. ะัะฟัะฐะฒะธัั: `GET /commands/query-all`
6. **ะะถะธะดะฐะฝะธะต:** Snapshot ัะพะดะตัะถะธั ััะฐััะต ะดะฐะฝะฝัะต (ะดะพ ะพััะฐะฝะพะฒะบะธ PrintSrv)
7. ะะฐะฟัััะธัั PrintSrv
8. ะะพะดะพะถะดะฐัั 10 ัะตะบัะฝะด (2 ัะธะบะปะฐ)
9. ะัะฟัะฐะฒะธัั: `GET /commands/query-all`
10. **ะะถะธะดะฐะฝะธะต:** Snapshot ัะพะดะตัะถะธั `command: 111` ะธ `222`

**ะัะธัะตัะธะธ ััะฟะตัะฐ:**

- โ ะะพะผะฐะฝะดั ะฝะต ะฟะพัะตััะฝั ะฟัะธ ะฒัะตะผะตะฝะฝะพะน ะฝะตะดะพัััะฟะฝะพััะธ
- โ ะะพัะปะต ะฒะพัััะฐะฝะพะฒะปะตะฝะธั ะบะพะผะฐะฝะดั ะทะฐะฟะธัะฐะปะธัั
- โ Snapshot ะฐะบััะฐะปะธะทะธัะพะฒะฐะปัั

---

### โ ะขะตัั 3: ะะฝะพะถะตััะฒะตะฝะฝัะต ะบะพะผะฐะฝะดั ะดะปั ะพะดะฝะพะณะพ unit

**ะจะฐะณะธ:**

1. ะััััะพ ะพัะฟัะฐะฒะธัั 5 ะบะพะผะฐะฝะด:
   ```bash
   POST /set?unit=1&value=100
   POST /set?unit=1&value=200
   POST /set?unit=1&value=300
   POST /set?unit=1&value=400
   POST /set?unit=1&value=500
   ```
2. ะะพะดะพะถะดะฐัั 5+ ัะตะบัะฝะด
3. ะัะฟัะฐะฒะธัั: `GET /commands/query-all`
4. **ะะถะธะดะฐะฝะธะต:** `command: 500` (ะฟะพัะปะตะดะฝัั ะบะพะผะฐะฝะดะฐ)

**ะัะธัะตัะธะธ ััะฟะตัะฐ:**

- โ Last-Write-Wins ัะฐะฑะพัะฐะตั ะบะพััะตะบัะฝะพ
- โ ะ PrintSrv ะทะฐะฟะธัะฐะปะฐัั ัะพะปัะบะพ ะฟะพัะปะตะดะฝัั ะบะพะผะฐะฝะดะฐ
- โ ะะตั ะดัะฑะปะธัะพะฒะฐะฝะธั ะทะฐะฟัะพัะพะฒ

---

### โ ะขะตัั 4: ะะตัะตะฟะพะปะฝะตะฝะธะต ะฑััะตัะฐ

**ะจะฐะณะธ:**

1. ะััะฐะฝะพะฒะธัั PrintSrv
2. ะัะฟัะฐะฒะธัั 100 ะบะพะผะฐะฝะด (ะทะฐะฟะพะปะฝะธัั ะฑััะตั)
3. ะัะฟัะฐะฒะธัั 101-ั ะบะพะผะฐะฝะดั
4. **ะะถะธะดะฐะฝะธะต:** HTTP 503 + ัะพะพะฑัะตะฝะธะต "ะััะตั ะบะพะผะฐะฝะด ะฟะตัะตะฟะพะปะฝะตะฝ"

**ะัะธัะตัะธะธ ััะฟะตัะฐ:**

- โ ะััะตั ะทะฐัะธัะตะฝ ะพั ะฟะตัะตะฟะพะปะฝะตะฝะธั
- โ ะะปะธะตะฝั ะฟะพะปััะฐะตั ะฟะพะฝััะฝัั ะพัะธะฑะบั

---

## ๐ฏ ะัะธัะตัะธะธ ะณะพัะพะฒะฝะพััะธ

### ะคัะฝะบัะธะพะฝะฐะปัะฝัะต ััะตะฑะพะฒะฐะฝะธั:

- โ ะะปะธะตะฝั ะฟะพะปััะฐะตั ะพัะฒะตั ะฝะฐ `POST /set` < 50ms (ะฑะตะท ะพะถะธะดะฐะฝะธั PrintSrv)
- โ ะะพะผะฐะฝะดั ะทะฐะฟะธััะฒะฐัััั ะฒ PrintSrv ะฒ ัะปะตะดัััะตะผ scan cycle (โค 5 ัะตะบัะฝะด)
- โ `GET /query-all` ะฒะพะทะฒัะฐัะฐะตั ะดะฐะฝะฝัะต ะธะท snapshot (ะฐะบััะฐะปัะฝัะต ะฝะฐ ะผะพะผะตะฝั ะฟะพัะปะตะดะฝะตะณะพ ัะธะบะปะฐ)
- โ ะัะธ ะฝะตะดะพัััะฟะฝะพััะธ PrintSrv ะบะพะผะฐะฝะดั ะฝะฐะบะฐะฟะปะธะฒะฐัััั (ะดะพ 100)
- โ ะะพัะปะต ะฒะพัััะฐะฝะพะฒะปะตะฝะธั PrintSrv ะบะพะผะฐะฝะดั ะทะฐะฟะธััะฒะฐัััั

### ะะตััะฝะบัะธะพะฝะฐะปัะฝัะต ััะตะฑะพะฒะฐะฝะธั:

- โ ะะตั race conditions (ะพะดะธะฝ ะฟะพัะพะบ ะดะปั write)
- โ Thread-safe ะฑััะตั ะธ snapshot
- โ Graceful degradation ะฟัะธ ะพัะธะฑะบะฐั PrintSrv
- โ ะะพะณะธัะพะฒะฐะฝะธะต ะฒัะตั ะบัะธัะธัะตัะบะธั ัะพะฑััะธะน
- โ ะะตั memory leaks (ะฑััะตั ะพะณัะฐะฝะธัะตะฝ, snapshot immutable)

### ะะณัะฐะฝะธัะตะฝะธั (by design):

- โ๏ธ Eventual Consistency: ะทะฐะดะตัะถะบะฐ ะดะพ 5 ัะตะบัะฝะด
- โ๏ธ Last-Write-Wins: ะพะดะฝะพะฒัะตะผะตะฝะฝัะต ะบะพะผะฐะฝะดั ะฝะต ะบะพะฝัะปะธะบัััั
- โ๏ธ No Persistence: ะบะพะผะฐะฝะดั ัะตัััััั ะฟัะธ ะฟะตัะตะทะฐะฟััะบะต
- โ๏ธ No Retry: ะบะพะผะฐะฝะดั ัะตัััััั ะฟัะธ ะพัะธะฑะบะต ะทะฐะฟะธัะธ ะฒ PrintSrv

---

## ๐ ะะพััะดะพะบ ัะตะฐะปะธะทะฐัะธะธ

**ะะตะฝั 1:**

- ะคะฐะทะฐ 1: PendingCommandsBuffer (ะทะฐะดะฐัะธ 1.1, 1.2)
- ะคะฐะทะฐ 2: ScadaDataPollingService (ะทะฐะดะฐัะธ 2.1, 2.2, 2.3)

**ะะตะฝั 2:**

- ะคะฐะทะฐ 3: CommandsService (ะทะฐะดะฐัะธ 3.1, 3.2)
- ะคะฐะทะฐ 4: ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ (ะทะฐะดะฐัะธ 4.1, 4.2, 4.3)

**ะะตะฝั 3:**

- ะคะฐะทะฐ 5: Thread Safety (ะทะฐะดะฐัะธ 5.1, 5.2)
- ะขะตััะธัะพะฒะฐะฝะธะต (ัะตััั 1, 2, 3, 4)

**ะะตะฝั 4:**

- ะะพะณะธัะพะฒะฐะฝะธะต (ะปะพะณะณะตัั SLF4J ะดะปั ะฒัะตั ะบัะธัะธัะตัะบะธั ะผะตัั)
- ะะพะบัะผะตะฝัะฐัะธั (JavaDoc ะดะปั ะฟัะฑะปะธัะฝัั ะผะตัะพะดะพะฒ)
- Code Review

---

## โ๏ธ ะััะธัะตะบัััะฝัะต ัะตัะตะฝะธั ะธ ะบะพะผะฟัะพะผะธััั

### โ ะัะตะธะผััะตััะฒะฐ Scan Cycle ะฟะพะดัะพะดะฐ:

1. **ะัะพััะพัะฐ:** ะะดะธะฝ ะฟะพัะพะบ, ะปะธะฝะตะนะฝะฐั ะปะพะณะธะบะฐ, ะฝะตั ัะปะพะถะฝะพะน ัะธะฝััะพะฝะธะทะฐัะธะธ
2. **ะะฐะดะตะถะฝะพััั:** ะัะบะปััะตะฝั race conditions ะฟะพ ะดะธะทะฐะนะฝั
3. **ะัะพะณะฝะพะทะธััะตะผะพััั:** ะงะตัะบะธะน ัะธะบะป ััะตะฝะธะตโะปะพะณะธะบะฐโะทะฐะฟะธัั
4. **ะกะพะพัะฒะตัััะฒะธะต ััะฐะฝะดะฐััะฐะผ:** ะะปะฐััะธัะตัะบะธะน ะฟะฐััะตัะฝ ะดะปั PLC/SCADA ัะธััะตะผ
5. **Debuggability:** ะะตะณะบะพ ะพััะปะตะดะธัั ะฟะพัะพะบ ะดะฐะฝะฝัั

### โ๏ธ ะะพะผะฟัะพะผะธััั:

1. **ะะฐะดะตัะถะบะฐ ะฒะธะดะธะผะพััะธ ะธะทะผะตะฝะตะฝะธะน:** ะะพ 1 ัะตะบัะฝะดั (ะบะปะธะตะฝั ะฟะพะปััะฐะตั ะพัะฒะตั ะผะณะฝะพะฒะตะฝะฝะพ, ะฝะพ ะธะทะผะตะฝะตะฝะธั ะฒ `GET /query-all`
   ะฒะธะดะฝั ะฟะพัะปะต ัะปะตะดัััะตะณะพ ัะธะบะปะฐ)
    - **ะะธัะธะณะฐัะธั:** ะัะธะตะผะปะตะผะพ ะดะปั ะผะพะฑะธะปัะฝัั ะฟัะธะปะพะถะตะฝะธะน (ะฟะพะปัะทะพะฒะฐัะตะปั ะฝะต ะทะฐะผะตัะฐะตั)
    - **ะฃะปัััะตะฝะธะต:** ะะพะถะฝะพ ัะฝะธะทะธัั ะดะพ 500ms, ะตัะปะธ ะฝัะถะฝะฐ ะฑะพะปะตะต ะฑััััะฐั ัะธะฝััะพะฝะธะทะฐัะธั

2. **ะะพัะตัั ะบะพะผะฐะฝะด ะฟัะธ ะพัะธะฑะบะต:** ะะตั retry-ะผะตัะฐะฝะธะทะผะฐ
    - **ะะธัะธะณะฐัะธั:** ะะปะธะตะฝั ะผะพะถะตั ะฟะพะฒัะพัะธัั ะทะฐะฟัะพั ะฟะพ ัะฐะนะผะฐััั ะธะปะธ ะฟะพะบะฐะทะฐัั "ะฟะพะฒัะพัะธัั"

3. **ะะณัะฐะฝะธัะตะฝะธะต throughput:** ะะฐะบัะธะผัะผ 100 ะบะพะผะฐะฝะด ะทะฐ 1 ัะตะบัะฝะดั = 100 RPS
    - **ะะธัะธะณะฐัะธั:** ะะพะปะตะต ัะตะผ ะดะพััะฐัะพัะฝะพ ะดะปั ะผะพะฑะธะปัะฝัั ะบะปะธะตะฝัะพะฒ

4. **Eventual Consistency:** Snapshot ะผะพะถะตั ะพัััะฐะฒะฐัั ะพั ัะตะฐะปัะฝะพััะธ ะฝะฐ โค1 ัะตะบัะฝะดั
    - **ะะธัะธะณะฐัะธั:** PrintSrv = ะธััะพัะฝะธะบ ะฟัะฐะฒะดั, snapshot ะดะพะณะพะฝัะตั ะบะฐะถะดัั ัะตะบัะฝะดั

### ๐ฏ ะะพัะตะผั ััะพ ะฟัะฐะฒะธะปัะฝะพะต ัะตัะตะฝะธะต:

- **ะขัะตะฑะพะฒะฐะฝะธะต ััะบะพะฒะพะดะธัะตะปั:** "ะงัะตะฝะธะต ะธ ะทะฐะฟะธัั ะฒ ะพะดะฝะพะผ ะฟะพัะพะบะต ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพ"
- **ะัะพะผััะปะตะฝะฝัะน ััะฐะฝะดะฐัั:** PLC Scan Cycle ะธัะฟะพะปัะทัะตััั ะฒ Siemens, Rockwell, Schneider
- **ะะตะทะพะฟะฐัะฝะพััั:** ะะตั ะณะพะฝะพะบ, ะฝะตั deadlocks, ะฝะตั ัะปะพะถะฝะพะน ัะธะฝััะพะฝะธะทะฐัะธะธ
- **ะะฐัััะฐะฑ ะฟัะพะตะบัะฐ:** ะะพะฑะธะปัะฝะพะต ะฟัะธะปะพะถะตะฝะธะต, ะฝะต ะฒััะพะบะพะฝะฐะณััะถะตะฝะฝะฐั ัะธััะตะผะฐ

---

## ๐ง ะะพะปะตะทะฝัะต ะบะพะผะฐะฝะดั

**ะัะพะฒะตัะธัั snapshot:**

```powershell
curl http://localhost:8080/commands/query-all
```

**ะัะฟัะฐะฒะธัั ะบะพะผะฐะฝะดั:**

```powershell
curl -X POST "http://localhost:8080/commands/set?unit=1&value=999"
```

**ะัะพะฒะตัะธัั ัะฐะทะผะตั ะฑััะตัะฐ (debug endpoint):**

```powershell
# ะะพะฑะฐะฒะธัั ะฒ CommandsController:
# @GetMapping("/debug/buffer-size")
# public int getBufferSize() { return pendingCommandsBuffer.size(); }

curl http://localhost:8080/commands/debug/buffer-size
```

**ะะพะฝะธัะพัะธะฝะณ ะปะพะณะพะฒ:**

```powershell
Get-Content -Path "logs/spring.log" -Wait | Select-String -Pattern "scanCycle|PendingCommandsBuffer"
```

---

## ๐ ะะพะฟะพะปะฝะธัะตะปัะฝัะต ะผะฐัะตัะธะฐะปั

**ะะปั ะฟะพะฝะธะผะฐะฝะธั ะบะพะฝัะตะฟัะธะธ:**

- PLC Scan Cycle: https://www.plcacademy.com/plc-scan-cycle/
- Eventually Consistent Systems: Martin Kleppmann "Designing Data-Intensive Applications"

**ะะปั ัะปัััะตะฝะธั (ะฟะพัะปะต ะฑะฐะทะพะฒะพะน ัะตะฐะปะธะทะฐัะธะธ):**

- ะะตััะธะบะธ: Spring Boot Actuator + Micrometer (track scan cycle duration, buffer size)
- ะะตััะธััะตะฝัะฝะพััั: Spring Boot + embedded H2 ะดะปั ัะพััะฐะฝะตะฝะธั ะบะพะผะฐะฝะด ะฟัะธ ะฟะตัะตะทะฐะฟััะบะต
- ะัะธะพัะธัะตะทะฐัะธั: Priority Queue ะดะปั ะบัะธัะธัะฝัั ะบะพะผะฐะฝะด

---

**ะะตััะธั:** 2.0 (Scan Cycle Architecture)  
**ะะฐัะฐ:** 10.02.2026  
**ะะฒัะพั:** Architecture Design ะดะปั SCADA Mobile Backend  
**ะกะพะณะปะฐัะพะฒะฐะฝะพ:** ะัะบะพะฒะพะดะธัะตะปั ะฟัะพะตะบัะฐ (ะฐะปะณะพัะธัะผ ััะตะฝะธะตโะปะพะณะธะบะฐโะทะฐะฟะธัั)

