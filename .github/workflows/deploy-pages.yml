name: ĞŸĞ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğµ PWA Ğ² GitHub Pages

# WORKFLOW CONFIGURATION (v2)
# Automatic PWA deployment to GitHub Pages on push to main branch
# All actions are explicitly pinned to their latest stable versions
# No deprecated v3 artifact actions are used in this workflow
# This file has been completely rewritten to ensure GitHub clears all cached action metadata

# Trigger events for this workflow
on:
  # Push trigger on main branch
  push:
    branches: [main]
    # Only trigger on pwa-app or workflow file changes
    paths:
      - "pwa-app/**"
      - ".github/workflows/deploy-pages.yml"

  # Manual trigger for emergency deployments
  workflow_dispatch:

# Permissions required by GitHub Actions
permissions:
  contents: read
  pages: write
  id-token: write

# Concurrency control - ensure only one deployment at a time
# Previous runs will be cancelled if new push is triggered
concurrency:
  group: "pages"
  cancel-in-progress: true

# ========================== BEGIN JOBS ==========================

jobs:
  # ==== STAGE 1: PREPARE AND VALIDATE ====
  prepare:
    name: Prepare PWA Build
    runs-on: ubuntu-latest

    outputs:
      build_timestamp: ${{ steps.timestamp.outputs.timestamp }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate timestamp
        id: timestamp
        run: echo "timestamp=$(date -u +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT

      - name: Validate PWA structure
        run: |
          echo "âœ“ Checking PWA application structure..."
          required_files=(
            "pwa-app/index.html"
            "pwa-app/manifest.webmanifest"
            "pwa-app/service-worker.js"
            "pwa-app/.well-known/assetlinks.json"
          )
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âœ— ERROR: Required file missing: $file"
              exit 1
            fi
            echo "âœ“ Found: $file"
          done
          echo ""
          echo "âœ“ All required files present!"

      - name: Validate JSON files
        run: |
          echo "âœ“ Validating JSON files..."
          jq empty pwa-app/manifest.webmanifest && echo "âœ“ manifest.webmanifest is valid" || {
            echo "âœ— ERROR: manifest.webmanifest has invalid JSON"
            exit 1
          }
          jq empty pwa-app/.well-known/assetlinks.json && echo "âœ“ assetlinks.json is valid" || {
            echo "âœ— ERROR: assetlinks.json has invalid JSON"
            exit 1
          }

  # ==== STAGE 2: BUILD ====
jobs:
  build:
    name: Build PWA
    runs-on: ubuntu-latest
    needs: prepare

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # <-- Ğ¿Ñ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ° ĞºÑÑˆĞ° GitHub Actions -->
      - name: Clear cached packages
        uses: awalsh128/cache-apt-pkgs-action@v1.4.3
        with:
          clear-cache: true

      - name: Check for build dependencies
        id: check_build
        run: |
          if [ -f "pwa-app/package.json" ]; then
            echo "has_build=true" >> $GITHUB_OUTPUT
            echo "âœ“ Found package.json in pwa-app"
          else
            echo "has_build=false" >> $GITHUB_OUTPUT
            echo "â„¹ No package.json found - using PWA as-is"
          fi

      - name: Setup Node.js and install dependencies
        if: steps.check_build.outputs.has_build == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install PWA dependencies
        if: steps.check_build.outputs.has_build == 'true'
        run: |
          cd pwa-app
          npm install --omit=dev
          echo "âœ“ Dependencies installed successfully"

      - name: Verify build
        run: |
          echo "âœ“ PWA build verification complete"
          echo "Files in pwa-app:"
          ls -la pwa-app/ | head -20

      - name: Upload PWA artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pwa-build
          path: pwa-app
          retention-days: 1
          if-no-files-found: error

  # ==== STAGE 3: DEPLOY TO GITHUB PAGES ====
  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [prepare, build]

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download PWA artifacts
        uses: actions/download-artifact@v4
        with:
          name: pwa-build
          path: ./pwa-app

      - name: Prepare deployment
        run: |
          echo "âœ“ Preparing PWA for deployment..."
          echo ""
          echo "ğŸ“¦ PWA structure:"
          ls -la pwa-app/
          echo ""
          if [ -f "pwa-app/index.html" ]; then
            echo "âœ“ index.html found"
          else
            echo "âœ— ERROR: index.html not found!"
            exit 1
          fi
          if [ -f "pwa-app/manifest.webmanifest" ]; then
            echo "âœ“ manifest.webmanifest found"
          else
            echo "âœ— ERROR: manifest.webmanifest not found!"
            exit 1
          fi
          if [ -f "pwa-app/.well-known/assetlinks.json" ]; then
            echo "âœ“ .well-known/assetlinks.json found (TWA support)"
          fi
          echo ""
          echo "âœ“ All files ready for deployment"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v2
        with:
          path: "./pwa-app"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2

      - name: Deployment summary
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ“ PWA successfully deployed to GitHub Pages!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“± Access your PWA at:"
          echo "   https://savushkin-dev.github.io/scada-mobile/"
          echo ""
          echo "ğŸ”— Digital Asset Links:"
          echo "   https://savushkin-dev.github.io/scada-mobile/.well-known/assetlinks.json"
          echo ""
          echo "ğŸ§ Deployment URL: ${{ steps.deployment.outputs.page_url }}"
          echo ""
