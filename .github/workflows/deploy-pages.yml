name: ĞŸĞ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğµ PWA Ğ² GitHub Pages

on:
  push:
    branches: [main]
    paths:
      - "pwa-app/**"
      - ".github/workflows/deploy-pwa.yml"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # ==== STAGE 1: PREPARE AND VALIDATE ====
  prepare:
    name: Prepare PWA Build
    runs-on: ubuntu-latest

    outputs:
      build_timestamp: ${{ steps.timestamp.outputs.timestamp }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate timestamp
        id: timestamp
        run: echo "timestamp=$(date -u +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT

      # FORCE: Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ° Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ĞºÑÑˆĞ° runner'Ğ° Ğ¿ĞµÑ€ĞµĞ´ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¾Ğ¹ action'Ğ¾Ğ²
      - name: Force clear local actions cache
        run: |
          echo "ğŸ§¹ Clearing runner local actions cache..."
          rm -rf $HOME/.cache/actions || true
          echo "âœ… Local actions cache cleared"

      - name: Validate PWA structure
        run: |
          echo "âœ“ Checking PWA application structure..."
          required_files=(
            "pwa-app/index.html"
            "pwa-app/manifest.webmanifest"
            "pwa-app/service-worker.js"
            "pwa-app/.well-known/assetlinks.json"
          )
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âœ— ERROR: Required file missing: $file"
              exit 1
            fi
            echo "âœ“ Found: $file"
          done
          echo ""
          echo "âœ“ All required files present!"

      - name: Validate JSON files
        run: |
          echo "âœ“ Validating JSON files..."
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi
          jq empty pwa-app/manifest.webmanifest && echo "âœ“ manifest.webmanifest is valid" || {
            echo "âœ— ERROR: manifest.webmanifest has invalid JSON"
            exit 1
          }
          jq empty pwa-app/.well-known/assetlinks.json && echo "âœ“ assetlinks.json is valid" || {
            echo "âœ— ERROR: assetlinks.json has invalid JSON"
            exit 1
          }

  # ==== STAGE 2: BUILD ====
  build:
    name: Build PWA
    runs-on: ubuntu-latest
    needs: prepare

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # <-- Ğ·Ğ°Ğ¼ĞµĞ½Ñ‘Ğ½Ğ½Ñ‹Ğ¹ ÑˆĞ°Ğ³: Ğ¿Ñ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ° ĞºĞµÑˆĞ° Ñ€Ğ°Ğ½Ğ½ĞµÑ€Ğ° Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ -->
      - name: Force clear runner caches and apt lists
        run: |
          echo "ğŸ§¹ Clearing runner local actions cache..."
          rm -rf $HOME/.cache/actions || true
          rm -rf $HOME/.npm || true
          rm -rf $HOME/.cache || true

          echo "ğŸ§¹ Cleaning apt caches to avoid stale cached packages..."
          sudo apt-get clean -y || true
          sudo rm -rf /var/lib/apt/lists/* || true
          sudo apt-get update -y || true

          echo "âœ… Runner caches and apt lists cleared"

      - name: Check for build dependencies
        id: check_build
        run: |
          if [ -f "pwa-app/package.json" ]; then
            echo "has_build=true" >> $GITHUB_OUTPUT
            echo "âœ“ Found package.json in pwa-app"
          else
            echo "has_build=false" >> $GITHUB_OUTPUT
            echo "â„¹ No package.json found - using PWA as-is"
          fi

      - name: Setup Node.js and install dependencies
        if: steps.check_build.outputs.has_build == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install PWA dependencies
        if: steps.check_build.outputs.has_build == 'true'
        run: |
          cd pwa-app
          npm install --omit=dev
          echo "âœ“ Dependencies installed successfully"

      - name: Verify build
        run: |
          echo "âœ“ PWA build verification complete"
          echo "Files in pwa-app:"
          ls -la pwa-app/ | head -20

      - name: Upload PWA artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pwa-build
          path: pwa-app
          retention-days: 1
          if-no-files-found: error

  # ==== STAGE 3: DEPLOY TO GITHUB PAGES ====
  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [prepare, build]

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download PWA artifacts
        uses: actions/download-artifact@v4
        with:
          name: pwa-build
          path: ./pwa-app

      - name: Prepare deployment
        run: |
          echo "âœ“ Preparing PWA for deployment..."
          echo ""
          echo "ğŸ“¦ PWA structure:"
          ls -la pwa-app/
          echo ""
          if [ -f "pwa-app/index.html" ]; then
            echo "âœ“ index.html found"
          else
            echo "âœ— ERROR: index.html not found!"
            exit 1
          fi
          if [ -f "pwa-app/manifest.webmanifest" ]; then
            echo "âœ“ manifest.webmanifest found"
          else
            echo "âœ— ERROR: manifest.webmanifest not found!"
            exit 1
          fi
          if [ -f "pwa-app/.well-known/assetlinks.json" ]; then
            echo "âœ“ .well-known/assetlinks.json found (TWA support)"
          fi
          echo ""
          echo "âœ“ All files ready for deployment"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        # Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ v3 â€” Ğ² Ñ€ÑĞ´Ğµ ÑĞ»ÑƒÑ‡Ğ°ĞµĞ² ÑÑ‚Ğ¾ Ñ€ĞµÑˆĞ°ĞµÑ‚ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ¸Ñ‚Ğ¸Ğ²Ğ½ÑƒÑ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñƒ Ñ ÑƒÑÑ‚Ğ°Ñ€ĞµĞ²ÑˆĞ¸Ğ¼Ğ¸ upload-artifact:v3
        uses: actions/upload-pages-artifact@v3
        with:
          path: "./pwa-app"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2

      - name: Deployment summary
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ“ PWA successfully deployed to GitHub Pages!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“± Access your PWA at:"
          echo "   https://savushkin-dev.github.io/scada-mobile/"
          echo ""
          echo "ğŸ”— Digital Asset Links:"
          echo "   https://savushkin-dev.github.io/scada-mobile/.well-known/assetlinks.json"
          echo ""
          echo "ğŸ§ Deployment URL: ${{ steps.deployment.outputs.page_url }}"
          echo ""
