name: Deploy PWA to GitHub Pages

# Ğ¢Ñ€Ğ¸Ğ³Ğ³ĞµÑ€Ñ‹ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° workflow
on:
  # Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿Ñ€Ğ¸ push Ğ² main branch
  push:
    branches: [main]
    # ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ: Ñ‚Ñ€Ğ¸Ğ³Ğ³ĞµÑ€ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ pwa-app
    paths:
      - "pwa-app/**"
      - ".github/workflows/deploy-pwa.yml"

  # Ğ ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº (Ğ´Ğ»Ñ ÑĞºÑÑ‚Ñ€ĞµĞ½Ğ½Ñ‹Ñ… ÑĞ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ğ¹)
  workflow_dispatch:

# Ğ Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ GitHub Actions
permissions:
  contents: read
  pages: write
  id-token: write

# Ğ•Ğ´Ğ¸Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ (Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ¸ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ñ‹)
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # Job 1: ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° Ğ¸ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ
  prepare:
    name: Prepare PWA Build
    runs-on: ubuntu-latest

    outputs:
      # Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²ĞµÑ€ÑĞ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… jobs
      build_timestamp: ${{ steps.timestamp.outputs.timestamp }}

    steps:
      # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ¾Ğ´Ğ° Ğ¸Ğ· Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ timestamp Ğ´Ğ»Ñ ĞºÑÑˆĞ° Ğ¸ Ğ»Ğ¾Ğ³Ğ¾Ğ²
      - name: Generate timestamp
        id: timestamp
        run: echo "timestamp=$(date -u +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT

      # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ² pwa-app
      - name: Validate PWA structure
        run: |
          echo "âœ“ Checking PWA application structure..."

          required_files=(
            "pwa-app/index.html"
            "pwa-app/manifest.webmanifest"
            "pwa-app/service-worker.js"
            "pwa-app/.well-known/assetlinks.json"
          )

          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âœ— ERROR: Required file missing: $file"
              exit 1
            fi
            echo "âœ“ Found: $file"
          done

          echo ""
          echo "âœ“ All required files present!"

      # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ JSON Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ½Ğ° Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ¾ÑÑ‚ÑŒ
      - name: Validate JSON files
        run: |
          echo "âœ“ Validating JSON files..."

          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ manifest.webmanifest
          jq empty pwa-app/manifest.webmanifest && echo "âœ“ manifest.webmanifest is valid" || {
            echo "âœ— ERROR: manifest.webmanifest has invalid JSON"
            exit 1
          }

          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ assetlinks.json
          jq empty pwa-app/.well-known/assetlinks.json && echo "âœ“ assetlinks.json is valid" || {
            echo "âœ— ERROR: assetlinks.json has invalid JSON"
            exit 1
          }

  # Job 2: Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° (ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ°)
  build:
    name: Build PWA
    runs-on: ubuntu-latest
    needs: prepare

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Ğ•ÑĞ»Ğ¸ Ğ² pwa-app ĞµÑÑ‚ÑŒ package.json, Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
      - name: Check for build dependencies
        id: check_build
        run: |
          if [ -f "pwa-app/package.json" ]; then
            echo "has_build=true" >> $GITHUB_OUTPUT
            echo "âœ“ Found package.json in pwa-app"
          else
            echo "has_build=false" >> $GITHUB_OUTPUT
            echo "â„¹ No package.json found - using PWA as-is"
          fi

      # Setup Node.js (ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ° ÑĞ±Ğ¾Ñ€ĞºĞ°)
      - name: Setup Node.js
        if: steps.check_build.outputs.has_build == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      # Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
      - name: Install dependencies
        if: steps.check_build.outputs.has_build == 'true'
        run: |
          cd pwa-app
          npm install --omit=dev
          echo "âœ“ Dependencies installed"

      # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸ ĞºÑÑˆĞ° Ğ¿ĞµÑ€ĞµĞ´ Ğ¸Ñ… ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼
      - name: Ensure cache directories exist
        if: steps.check_build.outputs.has_build == 'true'
        run: |
          mkdir -p ~/.npm
          mkdir -p ~/.cache/yarn
          mkdir -p .yarn/cache
          mkdir -p node_modules

      # ĞšÑÑˆĞ¸Ñ€ÑƒĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ´Ğ»Ñ ÑƒÑĞºĞ¾Ñ€ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ñ… Ğ·Ğ°Ğ¿ÑƒÑĞºĞ¾Ğ²
      - name: Cache dependencies
        if: steps.check_build.outputs.has_build == 'true'
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.npm
            ~/.cache/yarn
            .yarn/cache
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json', '**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ»Ğ¸Ğ½Ñ‚Ğ¸Ğ½Ğ³Ğ° (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
      - name: Lint PWA
        if: steps.check_build.outputs.has_build == 'true'
        run: |
          cd pwa-app
          # Ğ•ÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ lint, Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ĞµĞ³Ğ¾
          if grep -q '"lint"' package.json; then
            npm run lint
            echo "âœ“ Linting passed"
          else
            echo "â„¹ No lint script defined"
          fi
        continue-on-error: true

      # Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹ (Ğ¿Ğ°Ğ¿ĞºÑƒ pwa-app) Ğ´Ğ»Ñ ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ³Ğ¾ job
      - name: Upload PWA artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pwa-build
          path: pwa-app
          retention-days: 1
          if-no-files-found: error

  # Job 3: Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° GitHub Pages
  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [prepare, build]

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Ğ¡ĞºĞ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹ ÑĞ±Ğ¾Ñ€ĞºĞ¸
      - name: Download PWA artifacts
        uses: actions/download-artifact@v3
        with:
          name: pwa-build
          path: ./pwa-app

      # ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ Ğ´Ğ»Ñ Pages
      # (ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ pwa-app Ğ² ĞºĞ¾Ñ€ĞµĞ½ÑŒ Ğ´Ğ»Ñ Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸)
      - name: Prepare deployment
        run: |
          echo "âœ“ Preparing PWA for deployment..."

          # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ¿ĞµÑ€ĞµĞ´ Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸ĞµĞ¹
          echo ""
          echo "ğŸ“¦ PWA structure:"
          ls -la pwa-app/
          echo ""

          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ ĞµÑ‰Ğµ Ñ€Ğ°Ğ·
          if [ -f "pwa-app/index.html" ]; then
            echo "âœ“ index.html found"
          else
            echo "âœ— ERROR: index.html not found!"
            exit 1
          fi

          if [ -f "pwa-app/manifest.webmanifest" ]; then
            echo "âœ“ manifest.webmanifest found"
          else
            echo "âœ— ERROR: manifest.webmanifest not found!"
            exit 1
          fi

          if [ -f "pwa-app/.well-known/assetlinks.json" ]; then
            echo "âœ“ .well-known/assetlinks.json found (TWA support)"
          fi

          echo ""
          echo "âœ“ All files ready for deployment"

      # ĞĞ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼ Pages
      - name: Setup Pages
        uses: actions/configure-pages@v4

      # Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹ Ğ² Pages
      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v2
        with:
          path: "./pwa-app"

      # Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¸Ğ¼ Ğ½Ğ° Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2

      # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ± ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ¼ Ğ´ĞµĞ¿Ğ»Ğ¾Ğµ
      - name: Deployment summary
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ“ PWA successfully deployed to GitHub Pages!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“± Access your PWA at:"
          echo "   https://savushkin-dev.github.io/scada-mobile/"
          echo ""
          echo "ğŸ”— Digital Asset Links:"
          echo "   https://savushkin-dev.github.io/scada-mobile/.well-known/assetlinks.json"
          echo ""
          echo "ğŸ§ Deployment URL: ${{ steps.deployment.outputs.page_url }}"
          echo ""
