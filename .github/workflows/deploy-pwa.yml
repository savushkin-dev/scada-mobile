name: Deploy PWA to GitHub Pages

# WORKFLOW CONFIGURATION
# ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹ PWA Ğ½Ğ° GitHub Pages Ğ¿Ñ€Ğ¸ push Ğ² main Ğ²ĞµÑ‚ĞºÑƒ
# IMPORTANT: All artifact actions updated to v4 (no v3 used anywhere)
# If you see deprecation errors, this is a GitHub server-side cache issue

# Trigger events for this workflow
on:
  # Push trigger on main branch
  push:
    branches: [main]
    # Only trigger on pwa-app or workflow file changes
    paths:
      - "pwa-app/**"
      - ".github/workflows/deploy-pwa.yml"

  # Manual trigger for emergency deployments
  workflow_dispatch:

# Permissions required by GitHub Actions
permissions:
  contents: read
  pages: write
  id-token: write

# Concurrency control - ensure only one deployment at a time
# Previous runs will be cancelled if new push is triggered
concurrency:
  group: "pages"
  cancel-in-progress: true

# ========================== BEGIN JOBS ==========================

jobs:
  # ==== STAGE 1: PREPARE AND VALIDATE ====
  prepare:
    name: Prepare PWA Build
    runs-on: ubuntu-latest

    outputs:
      build_timestamp: ${{ steps.timestamp.outputs.timestamp }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate timestamp
        id: timestamp
        run: echo "timestamp=$(date -u +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT

      - name: Validate PWA structure
        run: |
          echo "âœ“ Checking PWA application structure..."
          required_files=(
            "pwa-app/index.html"
            "pwa-app/manifest.webmanifest"
            "pwa-app/service-worker.js"
            "pwa-app/.well-known/assetlinks.json"
          )
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âœ— ERROR: Required file missing: $file"
              exit 1
            fi
            echo "âœ“ Found: $file"
          done
          echo ""
          echo "âœ“ All required files present!"

      - name: Validate JSON files
        run: |
          echo "âœ“ Validating JSON files..."
          jq empty pwa-app/manifest.webmanifest && echo "âœ“ manifest.webmanifest is valid" || {
            echo "âœ— ERROR: manifest.webmanifest has invalid JSON"
            exit 1
          }
          jq empty pwa-app/.well-known/assetlinks.json && echo "âœ“ assetlinks.json is valid" || {
            echo "âœ— ERROR: assetlinks.json has invalid JSON"
            exit 1
          }

  # ==== STAGE 2: BUILD ====
  build:
    name: Build PWA
    runs-on: ubuntu-latest
    needs: prepare

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for build dependencies
        id: check_build
        run: |
          if [ -f "pwa-app/package.json" ]; then
            echo "has_build=true" >> $GITHUB_OUTPUT
            echo "âœ“ Found package.json in pwa-app"
          else
            echo "has_build=false" >> $GITHUB_OUTPUT
            echo "â„¹ No package.json found - using PWA as-is"
          fi

      - name: Setup Node.js
        if: steps.check_build.outputs.has_build == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Prepare cache directories
        if: steps.check_build.outputs.has_build == 'true'
        run: |
          mkdir -p ~/.npm
          mkdir -p ~/.cache/yarn
          mkdir -p pwa-app/node_modules
          echo "âœ“ Cache directories prepared"

      - name: Cache NPM dependencies
        if: steps.check_build.outputs.has_build == 'true'
        uses: actions/cache@v4
        with:
          path: |
            pwa-app/node_modules
            ~/.npm
            ~/.cache/yarn
          key: ${{ runner.os }}-npm-${{ hashFiles('pwa-app/package-lock.json', 'pwa-app/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install dependencies
        if: steps.check_build.outputs.has_build == 'true'
        run: |
          cd pwa-app
          npm install --omit=dev
          echo "âœ“ Dependencies installed"

      - name: Lint PWA
        if: steps.check_build.outputs.has_build == 'true'
        run: |
          cd pwa-app
          if grep -q '"lint"' package.json; then
            npm run lint
            echo "âœ“ Linting passed"
          else
            echo "â„¹ No lint script defined"
          fi
        continue-on-error: true

      - name: Upload PWA artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pwa-build
          path: pwa-app
          retention-days: 1
          if-no-files-found: error

  # ==== STAGE 3: DEPLOY TO GITHUB PAGES ====
  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [prepare, build]

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download PWA artifacts
        uses: actions/download-artifact@v4
        with:
          name: pwa-build
          path: ./pwa-app

      - name: Prepare deployment
        run: |
          echo "âœ“ Preparing PWA for deployment..."
          echo ""
          echo "ğŸ“¦ PWA structure:"
          ls -la pwa-app/
          echo ""
          if [ -f "pwa-app/index.html" ]; then
            echo "âœ“ index.html found"
          else
            echo "âœ— ERROR: index.html not found!"
            exit 1
          fi
          if [ -f "pwa-app/manifest.webmanifest" ]; then
            echo "âœ“ manifest.webmanifest found"
          else
            echo "âœ— ERROR: manifest.webmanifest not found!"
            exit 1
          fi
          if [ -f "pwa-app/.well-known/assetlinks.json" ]; then
            echo "âœ“ .well-known/assetlinks.json found (TWA support)"
          fi
          echo ""
          echo "âœ“ All files ready for deployment"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v2
        with:
          path: "./pwa-app"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2

      - name: Deployment summary
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ“ PWA successfully deployed to GitHub Pages!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“± Access your PWA at:"
          echo "   https://savushkin-dev.github.io/scada-mobile/"
          echo ""
          echo "ğŸ”— Digital Asset Links:"
          echo "   https://savushkin-dev.github.io/scada-mobile/.well-known/assetlinks.json"
          echo ""
          echo "ğŸ§ Deployment URL: ${{ steps.deployment.outputs.page_url }}"
          echo ""
